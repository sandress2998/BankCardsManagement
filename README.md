# Система управления банковскими картами

## Обзор проекта

Система управления банковскими картами реализует безопасную обработку финансовых данных с многоуровневой защитой, включая Spring Security с ролевой моделью, JWT-аутентификацию, двойное шифрование номеров карт и соответствие требованиям PCI DSS.

# Инструкция по развертыванию

## Общие сведения

Проект использует систему сборки **Gradle** и поддерживает развёртывание в нескольких средах:

- **dev** – с встроенной in-memory базой данных H2

- **prod** – с полноценной базой данных PostgreSQL через Docker


---

## Настройка среды разработки (dev)

- В `application-dev.yml` настроена база H2 с автоматическим созданием и удалением схемы (`ddl-auto: create-drop`).

- Этот профиль используется локально без Docker.


- Приложение будет доступно по адресу:

  text

  `http://localhost:8080`

- Swagger UI будет доступен по:

  text

  `http://localhost:8080/swagger-ui.html`


---

## Настройка среды продакшн (prod) с Docker

- Для продакшн-среды используется PostgreSQL, запущенный через Docker Compose.

- В корне проекта расположен файл `docker-compose.yml`, который определяет два сервиса:

    - **postgres-db**: контейнер с PostgreSQL

    - **bank-service**: сервис приложения на Spring Boot

- Для запуска в продакшне выполните:

  text

  `docker-compose up --build`

- Настройки подключения к базе определены в `application-prod.yml` с использованием переменных окружения (`DB_HOST`, `DB_PORT`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`).

- Порты для доступа:

    - Приложение:

      text

      `http://localhost:8080`

    - Swagger UI:

      text

      `http://localhost:8080/swagger-ui.html`


---

## Особенности безопасности

- Для получения роли **администратора** необходимо знать секретный пароль, который описан в Swagger документации при запросе роли администратора (`PATCH /api/user/admin`).

- Все запросы, кроме путей, связанных с аутентификацией (`/api/auth/**`), требуют авторизации через **JWT токен**.

- JWT токен нужно передавать в заголовке запроса:

  text

  `Authorization: Bearer <токен>`


---
# Детали

## Более развернутая документация находится в папке ./full_description

## 1. Безопасность

## Spring Security и управление доступом



- **Публичные эндпойнты**: `/api/auth/**`, `/v3/api-docs/**`, `/swagger-ui/**`

- **Аутентификация**: Все остальные запросы требуют JWT в заголовке Authorization


## Ролевая модель

- **USER** (`ROLE_USER`): Базовые операции с собственными картами

- **ADMIN** (`ROLE_ADMIN`): Административные функции, полный доступ к системе

- **Метод-level security**: `@PreAuthorize("hasRole('ROLE_ADMIN')")` для критичных операций


## JWT токены

- **Алгоритм**: HMAC с секретным ключом из конфигурации

- **Claims**: `sub` (UUID пользователя), `role` (USER/ADMIN), `iat`, `exp`

- **TTL**: 60 минут по умолчанию (настраивается через `security.jwt.duration`)

- **Передача**: Только по HTTPS, токен в заголовке `Authorization: Bearer <token>`


## Хранение паролей

- **Алгоритм**: BCrypt с автоматической солью

- **Класс**: `BCryptEncoder` с методами `encodePassword()` и `matches()`


## Защита номеров банковских карт (PAN)

**Envelope Encryption (двойное шифрование)**:

1. **DEK (Data Encryption Key)**: AES-128 ключ для каждой карты индивидуально

2. **Шифрование PAN**: Номер карты шифруется DEK через `EncryptionAES.encryptAES()`

3. **KEK (Key Encryption Key)**: Мастер-ключ шифрует DEK

4. **Хранение**: Зашифрованный номер и зашифрованный DEK в разных таблицах


**Маскирование**:

- Формат отображения: `**** **** **** XXXX` (только последние 4 цифры)

- Полный номер доступен только администраторам в тестовых методах (для облегчения тестирования и проверки)

- Соответствие PCI DSS Requirement 3.3


**HMAC для поиска**:

- HMAC-SHA256 хеши номеров карт в таблице `card_hash`

- Поиск карт без расшифровки всех номеров

- Отдельный HMAC-ключ из конфигурации


## 2. API (Swagger/OpenAPI)

## Документация

- **Swagger UI**: Доступен по `/swagger-ui.html`

- **OpenAPI спецификация**: `/v3/api-docs` (JSON), `/v3/api-docs.yaml` (YAML), ./docs/openapi.yml (В папке проекта)


## Структура API

- **Группы контроллеров**:

    - `Authentication API` (`/api/auth/**`): Регистрация, вход

    - `User API` (`/api/user/**`): Управление пользователями

    - `Card API` (`/api/card/**`): Операции с банковскими картами


## Коды ответов

- **200**: Успешная операция

- **201**: Создание ресурса

- **204**: Успешная операция без контента

- **400**: Некорректные входные данные

- **401**: Ошибка аутентификации

- **403**: Недостаточно прав доступа

- **404**: Ресурс не найден


## Примеры эндпойнтов

- `POST /api/auth/signin` - Аутентификация

- `POST /api/auth/signup` - Регистрация

- `GET /api/user/me` - Информация о текущем пользователе

- `POST /api/card` - Создание карты (ADMIN)

- `POST /api/card/transfer` - Денежный перевод


## 3. Тестирование

## Стратегия уровней тестирования

**Unit-тесты**: JUnit + Mockito для бизнес-логики сервисов

**Интеграционные тесты**: `@SpringBootTest` с полным контекстом приложения (для контроллеров)

## Критичные тест-кейсы

- **Аутентификация**: Валидация JWT, обработка некорректных токенов

- **Авторизация**: Проверка ролевого доступа к методам

- **Шифрование карт**: Корректность envelope encryption/decryption

- **Операции с балансом**: Валидация сумм, проверка достаточности средств

- **Маскирование**: Правильное отображение номеров карт


## 4. Миграции БД (Liquibase)

## Структура changelog

**Основной файл**: `changelog.yml` подключает модули:

- `001-create-users.yml` - Пользователи и UUID-расширение

- `002-create-cards.yml` - Таблица карт с ограничениями

- `003-create-card-encryption.yml` - Ключи шифрования

- `004-create-card-blocking.yml` - Заявки на блокировку

- `005-create-card-hash.yml` - HMAC хеши номеров

- `006-add-indexes.yml` - Индексы для оптимизации


## Правила и соглашения

- **Формат**: YAML для всех миграций

- **Именование changeset**: Последовательные ID, author = "developer"

- **Rollback**: Каждый changeset имеет обратные операции

- **Check-ограничения**: Через SQL для совместимости с Community Edition

- **Контекст**: `prod` для продакшн-миграций


## Схема БД

**Основные таблицы**:

- `user_info`: Пользователи (id, login, password, role)

- `card`: Банковские карты (id, encrypted_number, user_id, validity_period, status, balance)

- `card_encryption_key`: Зашифрованные DEK (id, card_id, encrypted_key)

- `card_blocking_request`: Заявки на блокировку (id, card_id)

- `card_hash`: HMAC хеши для поиска (id, hmac_hash)


## 5. Роли и матрица доступа

## Матрица прав доступа

|Операция|USER|ADMIN|Эндпойнт|Аннотация|
|---|---|---|---|---|
|**Регистрация/Вход**|✓|✓|`/api/auth/**`|Публичный|
|**Получение роли ADMIN**|✓|-|`PATCH /api/user/admin`|Аутентификация|
|**Информация о себе**|✓|✓|`GET /api/user/me`|Аутентификация|
|**Список пользователей**|✗|✓|`GET /api/user`|`@PreAuthorize("hasRole('ROLE_ADMIN')")`|
|**Создание карт**|✗|✓|`POST /api/card`|`@PreAuthorize("hasRole('ROLE_ADMIN')")`|
|**Активация/блокировка карт**|✗|✓|`PATCH /api/card/{id}`|`@PreAuthorize("hasRole('ROLE_ADMIN')")`|
|**Удаление карт**|✗|✓|`DELETE /api/card/{id}`|`@PreAuthorize("hasRole('ROLE_ADMIN')")`|
|**Просмотр карт**|✓ (свои, маскированные)|✓ (все, полные номера)|`GET /api/card`|Контекстный|
|**Операции с балансом**|✓|✓|`PATCH /api/card/balance/**`|Аутентификация|
|**Денежные переводы**|✓|✓|`POST /api/card/transfer`|Аутентификация|
|**Подача заявок на блокировку**|✓|✓|`POST /api/card/blocking/submit`|Аутентификация|
|**Обработка заявок**|✗|✓|`POST /api/card/blocking/process/{id}`|`@PreAuthorize("hasRole('ROLE_ADMIN')")`|

## Дополнительные механизмы безопасности

- **Проверка владельца**: Пользователи могут работать только со своими картами

- **Валидация статуса**: Операции только с активными картами (`ACTIVE` + не истекший срок)

- **Автоматическое истечение**: Планировщик `@Scheduled` ежедневно переводит просроченные карты в статус `EXPIRED`

- **Маскирование ошибок**: Общие сообщения "Internal error" вместо деталей реализации


## Требования к развертыванию

## Переменные окружения

- `security.jwt.secret` - Base64-кодированный секретный ключ для JWT

- `security.jwt.duration` - Время жизни токена в минутах (по умолчанию 60)

- `security.card.number.key` - Base64-кодированный мастер-ключ для шифрования карт

- `security.card.number.hmac` - Base64-кодированный ключ для HMAC

- `security.admin.secret` - Хешированный секрет для получения роли администратора

- `card.months-until-expires` - Срок действия карт в месяцах (по умолчанию 24)
